name: FukayaLab_Server

# --------------------------------------------------------------------------
#  ğŸ§© å¤–éƒ¨ã®Docker Composeãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šè¾¼ã‚€ (å„Webã‚µãƒ¼ãƒ“ã‚¹ãªã©)
# --------------------------------------------------------------------------
# ä¾‹: GitLabã‚„è‡ªä½œã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã‚’å€‹åˆ¥ã®Composeãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã—ã¦ã„ã‚‹å ´åˆ
# ãƒ‘ã‚¹ã¯ã“ã®docker-compose.ymlãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®šã—ã¾ã™ã€‚
# include:
#   - path: ../gitlab-stack/docker-compose.yml
#     # project_directory: ../gitlab-stack # å¿…è¦ã«å¿œã˜ã¦
#   - path: ../my-custom-webapp/docker-compose.yml
#     # project_directory: ../my-custom-webapp # å¿…è¦ã«å¿œã˜ã¦

services:
  # --------------------------------------------------------------------------
  #  ğŸŒ ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚· & HTTPSçµ‚ç«¯ (Caddy)
  # --------------------------------------------------------------------------
  caddy:
    image: caddy:2-alpine # Alpineãƒ™ãƒ¼ã‚¹ã®è»½é‡ã‚¤ãƒ¡ãƒ¼ã‚¸ (ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯é©å®œæœ€æ–°ã‚’ç¢ºèª)
    container_name: ReverseProxy_caddy
    hostname: caddy # ã‚³ãƒ³ãƒ†ãƒŠãƒ›ã‚¹ãƒˆå
    restart: unless-stopped
    ports:
      - "80:80"   # HTTP (HTTPSã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç”¨)
      - "443:443"  # HTTPS
      - "443:443/udp" # HTTP/3 (QUIC) ç”¨ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
    volumes:
      - ./caddy_config/Caddyfile:/etc/caddy/Caddyfile # TODO: Caddyfileã®ãƒ‘ã‚¹ã‚’å®Ÿéš›ã«åˆã‚ã›ã‚‹
      - caddy_data:/data # è¨¼æ˜æ›¸ãªã©ã®æ°¸ç¶šåŒ–
      - caddy_config_current:/config # Caddyã®ç¾åœ¨ã®è¨­å®šãªã©
    environment:
      - ACME_AGREE=true # Let's Encryptã®åˆ©ç”¨è¦ç´„ã«åŒæ„ (æœ¬ç•ªãƒ‰ãƒ¡ã‚¤ãƒ³ã®å ´åˆ)
      # - TZ=Asia/Tokyo # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š (ä»»æ„)
    networks:
      - frontend_network
      - shared_backend_network
    depends_on: # CaddyãŒèµ·å‹•ã™ã‚‹å‰ã«ãƒ—ãƒ­ã‚­ã‚·å…ˆã®ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚‹ç¨‹åº¦èµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’æœŸå¾… (å¿…é ˆã§ã¯ãªã„)
      - main_api
      - pgadmin
      - duplicati
      - portainer
      # - gitlab # includeã™ã‚‹å ´åˆã®ã‚µãƒ¼ãƒ“ã‚¹å (ä¾‹)
      # - my_custom_webapp_service # includeã™ã‚‹å ´åˆã®ã‚µãƒ¼ãƒ“ã‚¹å (ä¾‹)

  # --------------------------------------------------------------------------
  #  ğŸš€ ãƒ¡ã‚¤ãƒ³APIã‚µãƒ¼ãƒãƒ¼
  # --------------------------------------------------------------------------
  main_api:
    build:
      context: ./main_api_src # TODO: mainAPIã®DockerfileãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ãƒ‘ã‚¹
      dockerfile: Dockerfile
    container_name: main_api_server
    hostname: main_api
    restart: unless-stopped
    environment:
      # .envãƒ•ã‚¡ã‚¤ãƒ«ã®ä½¿ç”¨ã‚’æ¨å¥¨ (ä¾‹: POSTGRES_USER=${POSTGRES_USER})
      - NODE_ENV=production # ä¾‹: Node.jsã®å ´åˆ
      - DATABASE_HOST=postgres_db
      - DATABASE_PORT=5432
      - DATABASE_USER=your_db_user # TODO: .envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
      - DATABASE_PASSWORD=your_db_password # TODO: .envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
      - DATABASE_NAME=your_app_database # TODO: .envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
      # - JWT_SECRET=your_jwt_secret # TODO: .envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
      # ä»–ã€APIã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°
    volumes:
      - ./main_api_src:/usr/src/app # é–‹ç™ºæ™‚ã®ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ç”¨ (æœ¬ç•ªã§ã¯å‰Šé™¤ã¾ãŸã¯èª¿æ•´)
      - /usr/src/app/node_modules # â†‘ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆæ™‚ã«node_modulesãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã®ã‚’é˜²ã (Node.jsã®å ´åˆ)
    depends_on:
      postgres_db:
        condition: service_healthy # PostgreSQLãŒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ãƒ‘ã‚¹ã—ã¦ã‹ã‚‰èµ·å‹• (PostgreSQLå´ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®šãŒå¿…è¦)
    networks:
      - shared_backend_network
    # expose: # ã‚³ãƒ³ãƒ†ãƒŠé–“é€šä¿¡ã®ã¿ã§ãƒ›ã‚¹ãƒˆã«å…¬é–‹ã—ãªã„ãƒãƒ¼ãƒˆ
    #   - "3000" # mainAPIãŒãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ãƒãƒ¼ãƒˆ (ä¾‹)

  # --------------------------------------------------------------------------
  #  ğŸ˜ PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆDB, ãƒ­ã‚°DBãªã©)
  # --------------------------------------------------------------------------
  postgres_db:
    image: postgres:16-alpine # TODO: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯é©å®œé¸æŠ
    container_name: postgres_database
    hostname: postgres_db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=your_db_user # TODO: .envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
      - POSTGRES_PASSWORD=your_db_password # TODO: .envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
      - POSTGRES_DB=your_app_database # TODO: .envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
      - PGDATA=/var/lib/postgresql/data/pgdata # ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæŒ‡å®š (ä»»æ„)
    volumes:
      - postgres_db_data:/var/lib/postgresql/data/pgdata # DBãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–
      # - ./postgres_init_scripts:/docker-entrypoint-initdb.d # åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”¨ (ä»»æ„)
    ports: # é–‹ç™ºæ™‚ã‚„pgAdminä»¥å¤–ã‹ã‚‰ã®ç›´æ¥æ¥ç¶šãŒå¿…è¦ãªå ´åˆã®ã¿ãƒ›ã‚¹ãƒˆã«å…¬é–‹ã€‚é€šå¸¸ã¯ä¸è¦
    # - "5432:5432"
    healthcheck: # ç°¡å˜ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ä¾‹
      test: ["CMD-SHELL", "pg_isready -U your_db_user -d your_app_database"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - shared_backend_network

  # --------------------------------------------------------------------------
  #  ğŸ˜ PostgreSQL ç®¡ç†ãƒ„ãƒ¼ãƒ« (pgAdmin 4)
  # --------------------------------------------------------------------------
  pgadmin:
    image: dpage/pgadmin4:latest # TODO: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯é©å®œé¸æŠ
    container_name: pgadmin_manager
    hostname: pgadmin
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@example.com # TODO: å¤‰æ›´
      - PGADMIN_DEFAULT_PASSWORD=supersecretadminpassword # TODO: å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã€.envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
      # - PGADMIN_LISTEN_PORT=80 # ã‚³ãƒ³ãƒ†ãƒŠå†…ãƒãƒ¼ãƒˆ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯80)
    volumes:
      - pgadmin_data:/var/lib/pgadmin # pgAdminã®è¨­å®šã‚„ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šæƒ…å ±ã®æ°¸ç¶šåŒ–
    ports: # CaddyçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ã‚‹ãŸã‚ã€ãƒ›ã‚¹ãƒˆã¸ã®ç›´æ¥å…¬é–‹ã¯å¿…é ˆã§ã¯ãªã„
    # - "5050:80"
    depends_on:
      - postgres_db
    networks:
      - shared_backend_network

  # --------------------------------------------------------------------------
  #  ğŸ›¡ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (Duplicati)
  # --------------------------------------------------------------------------
  duplicati:
    image: duplicati/duplicati:latest # TODO: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯é©å®œé¸æŠ
    container_name: duplicati_backup_manager
    hostname: duplicati
    restart: unless-stopped
    volumes:
      - duplicati_config_data:/config # Duplicatiã®è¨­å®šãƒ‡ãƒ¼ã‚¿
      - duplicati_backups_storage:/backups # DuplicatiãŒæš—å·åŒ–ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã™ã‚‹å…ˆ (å®Ÿéš›ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‘ã‚¹ã«ãƒã‚¦ãƒ³ãƒˆæ¨å¥¨)
      - db_dumps_staging_area:/source_db_dumps # DBãƒ€ãƒ³ãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‡ºåŠ›å…ˆã§ã‚ã‚Šã€Duplicatiã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ƒ
      - ./duplicati_scripts:/scripts # pg_dumpã‚’å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãªã©ã‚’ç½®ãå ´æ‰€
    ports: # CaddyçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ã‚‹ãŸã‚ã€ãƒ›ã‚¹ãƒˆã¸ã®ç›´æ¥å…¬é–‹ã¯å¿…é ˆã§ã¯ãªã„
    # - "8200:8200"
    environment:
      - PUID=1000 # TODO: ãƒ›ã‚¹ãƒˆOSã®é©åˆ‡ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ID/ã‚°ãƒ«ãƒ¼ãƒ—IDã«å¤‰æ›´
      - PGID=1000
      - TZ=Asia/Tokyo # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š (ä»»æ„)
    # Duplicatiã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§DBãƒ€ãƒ³ãƒ—ã‚’ä½œæˆã™ã‚‹å ´åˆã€
    # Duplicatiã‚³ãƒ³ãƒ†ãƒŠãŒPostgreSQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«(pg_dump)ã‚’æŒã£ã¦ã„ãªã‘ã‚Œã°ã€
    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§ `docker exec -T postgres_db pg_dump ...` ã®ã‚ˆã†ã«
    # DBã‚³ãƒ³ãƒ†ãƒŠã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã€
    # ã‚ã‚‹ã„ã¯Duplicatiã‚³ãƒ³ãƒ†ãƒŠã«pg_dumpã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹Dockerfileã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
    # ã‚‚ã—ãã¯ã€pg_dumpã‚³ãƒãƒ³ãƒ‰ã‚’æŒã¤è»½é‡ãªã‚³ãƒ³ãƒ†ãƒŠã‚’ä¸€æ™‚çš„ã«èµ·å‹•ã—ã¦ãƒ€ãƒ³ãƒ—ã‚’ä½œæˆã—ã€
    # ãã®å‡ºåŠ›å…ˆã‚’DuplicatiãŒç›£è¦–ã™ã‚‹å½¢ã‚‚è€ƒãˆã‚‰ã‚Œã‚‹ã€‚
    # ã“ã“ã§ã¯ã€/scriptsã«ç½®ã‹ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½•ã‚‰ã‹ã®æ–¹æ³•ã§pg_dumpã‚’å®Ÿè¡Œã§ãã‚‹å‰æã€‚
    networks:
      - shared_backend_network # DBã‚³ãƒ³ãƒ†ãƒŠã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚
    depends_on:
      - postgres_db # DBãƒ€ãƒ³ãƒ—ä½œæˆã®ãŸã‚

  # --------------------------------------------------------------------------
  #  ğŸ‘€ ã‚³ãƒ³ãƒ†ãƒŠç®¡ç†ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  (Portainer CE)
  # --------------------------------------------------------------------------
  portainer:
    image: portainer/portainer-ce:latest # TODO: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯é©å®œé¸æŠ
    container_name: portainer_container_manager
    hostname: portainer
    restart: unless-stopped
    command: -H unix:///var/run/docker.sock # Dockerã‚½ã‚±ãƒƒãƒˆã‚’æŒ‡å®š
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Dockerã‚½ã‚±ãƒƒãƒˆã‚’ãƒã‚¦ãƒ³ãƒˆ
      - portainer_data:/data # Portainerã®è¨­å®šãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–
    ports: # CaddyçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ã‚‹ãŸã‚ã€ãƒ›ã‚¹ãƒˆã¸ã®ç›´æ¥å…¬é–‹ã¯å¿…é ˆã§ã¯ãªã„