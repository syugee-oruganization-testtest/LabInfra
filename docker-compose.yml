name: FukayaLab_Server

# --------------------------------------------------------------------------
#  ğŸ§© å¤–éƒ¨ã®Docker Composeãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šè¾¼ã‚€ (å„Webã‚µãƒ¼ãƒ“ã‚¹ãªã©)
# --------------------------------------------------------------------------
# ä¾‹: GitLabã‚„è‡ªä½œã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã‚’å€‹åˆ¥ã®Composeãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã—ã¦ã„ã‚‹å ´åˆ
# ãƒ‘ã‚¹ã¯ã“ã®docker-compose.ymlãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®šã—ã¾ã™ã€‚
# include:
#   - path: ../gitlab-stack/docker-compose.yml
#     # project_directory: ../gitlab-stack # å¿…è¦ã«å¿œã˜ã¦
#   - path: ../my-custom-webapp/docker-compose.yml
#     # project_directory: ../my-custom-webapp # å¿…è¦ã«å¿œã˜ã¦

services:
  # --------------------------------------------------------------------------
  #  ğŸŒ ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚· & HTTPSçµ‚ç«¯ (Caddy)
  # --------------------------------------------------------------------------
  caddy:
    image: caddy:2-alpine
    container_name: ReverseProxy_caddy
    hostname: reverse_proxy # ã‚³ãƒ³ãƒ†ãƒŠãƒ›ã‚¹ãƒˆå
    restart: unless-stopped
    ports:
      - "80:80"   # HTTP (HTTPSã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç”¨)
      - "443:443"  # HTTPS
#      - "443:443/udp" # HTTP/3 (QUIC) ç”¨ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
    volumes:
      - ./Entry/ReverseProxy/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data # è¨¼æ˜æ›¸ãªã©ã®æ°¸ç¶šåŒ–
      - caddy_config:/config # Caddyã®ç¾åœ¨ã®è¨­å®šãªã©
    environment:
      - ACME_AGREE=true # Let's Encryptã®åˆ©ç”¨è¦ç´„ã«åŒæ„ (æœ¬ç•ªãƒ‰ãƒ¡ã‚¤ãƒ³ã®å ´åˆ)
      - TZ=Asia/Tokyo # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š (ä»»æ„)
    networks:
      - frontend_network
      - shared_backend_network
    depends_on: # CaddyãŒèµ·å‹•ã™ã‚‹å‰ã«ãƒ—ãƒ­ã‚­ã‚·å…ˆã®ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚‹ç¨‹åº¦èµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’æœŸå¾… (å¿…é ˆã§ã¯ãªã„)
      - main_api
      - pgadmin
      - duplicati
      - portainer

  # --------------------------------------------------------------------------
  #  ğŸŒ DNS
  # --------------------------------------------------------------------------
  coreDNS:


  # --------------------------------------------------------------------------
  #  ğŸš€ ãƒ¡ã‚¤ãƒ³APIã‚µãƒ¼ãƒãƒ¼
  # --------------------------------------------------------------------------
  main_api:
    build:
      context: ./Application/MainAPIM
      dockerfile: Dockerfile
    container_name: MainAPI_nodejs
    hostname: main_api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_NAME=${POSTGRES_DB}
      - APP_LOG_LEVEL=${LOG_LEVEL}
      # - JWT_SECRET=your_jwt_secret # TODO: .envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
      # ä»–ã€APIã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°
    volumes:
      - ./Application/MainAPI/src:/usr/src/app # é–‹ç™ºæ™‚ã®ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ç”¨ (æœ¬ç•ªã§ã¯å‰Šé™¤ã¾ãŸã¯èª¿æ•´)
      - /usr/src/app/node_modules # â†‘ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆæ™‚ã«node_modulesãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã®ã‚’é˜²ã
    depends_on:
      postgres_db:
        condition: service_healthy # PostgreSQLãŒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ãƒ‘ã‚¹ã—ã¦ã‹ã‚‰èµ·å‹• (PostgreSQLå´ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®šãŒå¿…è¦)
    networks:
      - shared_backend_network


  # --------------------------------------------------------------------------
  #  ğŸ˜ PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (ã‚¢ã‚«ã‚¦ãƒ³ãƒˆDB, ãƒ­ã‚°DBãªã©)
  # --------------------------------------------------------------------------
  postgres_db:
    image: postgres:17-alpine
    container_name: MainDB_postgres
    hostname: main_db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres_db_data:/var/lib/postgresql/data/pgdata # DBãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U your_db_user -d your_app_database"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - shared_backend_network

  # --------------------------------------------------------------------------
  #  ğŸ˜ PostgreSQL ç®¡ç†ãƒ„ãƒ¼ãƒ« (pgAdmin 4)
  # --------------------------------------------------------------------------
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: DatabaseManager_postgres
    hostname: db_manager
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@example.com # TODO: å¤‰æ›´
      - PGADMIN_DEFAULT_PASSWORD=supersecretadminpassword # TODO: å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã€.envãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†
      # - PGADMIN_LISTEN_PORT=80 # ã‚³ãƒ³ãƒ†ãƒŠå†…ãƒãƒ¼ãƒˆ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯80)
    volumes:
      - pgadmin_data:/var/lib/pgadmin # pgAdminã®è¨­å®šã‚„ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šæƒ…å ±ã®æ°¸ç¶šåŒ–
    ports: # CaddyçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ã‚‹ãŸã‚ã€ãƒ›ã‚¹ãƒˆã¸ã®ç›´æ¥å…¬é–‹ã¯å¿…é ˆã§ã¯ãªã„
    # - "5050:80"
    depends_on:
      - postgres_db
    networks:
      - shared_backend_network

  # --------------------------------------------------------------------------
  #  ğŸ›¡ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (Duplicati)
  # --------------------------------------------------------------------------
  duplicati:
    image: duplicati/duplicati:latest
    container_name: BackupManager_duplicati
    hostname: backup_manager
    restart: unless-stopped
    volumes:
      - duplicati_config_data:/config # Duplicatiã®è¨­å®šãƒ‡ãƒ¼ã‚¿
      - duplicati_backups_storage:/backups # DuplicatiãŒæš—å·åŒ–ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã™ã‚‹å…ˆ (å®Ÿéš›ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‘ã‚¹ã«ãƒã‚¦ãƒ³ãƒˆæ¨å¥¨)
      - db_dumps_staging_area:/source_db_dumps # DBãƒ€ãƒ³ãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‡ºåŠ›å…ˆã§ã‚ã‚Šã€Duplicatiã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ƒ
      - ./duplicati_scripts:/scripts # pg_dumpã‚’å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãªã©ã‚’ç½®ãå ´æ‰€
    environment:
      - PUID=1000 # TODO: ãƒ›ã‚¹ãƒˆOSã®é©åˆ‡ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ID/ã‚°ãƒ«ãƒ¼ãƒ—IDã«å¤‰æ›´
      - PGID=1000
      - TZ=Asia/Tokyo # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š (ä»»æ„)
    # Duplicatiã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§DBãƒ€ãƒ³ãƒ—ã‚’ä½œæˆã™ã‚‹å ´åˆã€
    # Duplicatiã‚³ãƒ³ãƒ†ãƒŠãŒPostgreSQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«(pg_dump)ã‚’æŒã£ã¦ã„ãªã‘ã‚Œã°ã€
    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§ `docker exec -T postgres_db pg_dump ...` ã®ã‚ˆã†ã«
    # DBã‚³ãƒ³ãƒ†ãƒŠã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã€
    # ã‚ã‚‹ã„ã¯Duplicatiã‚³ãƒ³ãƒ†ãƒŠã«pg_dumpã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹Dockerfileã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
    # ã‚‚ã—ãã¯ã€pg_dumpã‚³ãƒãƒ³ãƒ‰ã‚’æŒã¤è»½é‡ãªã‚³ãƒ³ãƒ†ãƒŠã‚’ä¸€æ™‚çš„ã«èµ·å‹•ã—ã¦ãƒ€ãƒ³ãƒ—ã‚’ä½œæˆã—ã€
    # ãã®å‡ºåŠ›å…ˆã‚’DuplicatiãŒç›£è¦–ã™ã‚‹å½¢ã‚‚è€ƒãˆã‚‰ã‚Œã‚‹ã€‚
    # ã“ã“ã§ã¯ã€/scriptsã«ç½®ã‹ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½•ã‚‰ã‹ã®æ–¹æ³•ã§pg_dumpã‚’å®Ÿè¡Œã§ãã‚‹å‰æã€‚
    networks:
      - shared_backend_network # DBã‚³ãƒ³ãƒ†ãƒŠã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚
    depends_on:
      - postgres_db # DBãƒ€ãƒ³ãƒ—ä½œæˆã®ãŸã‚
    profiles:
      - extra
  # --------------------------------------------------------------------------
  #  ğŸ‘€ ã‚³ãƒ³ãƒ†ãƒŠç®¡ç†ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  (Portainer CE)
  # --------------------------------------------------------------------------
  portainer:
    image: portainer/portainer-ce:latest # TODO: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯é©å®œé¸æŠ
    container_name: ContainerManager_portainer
    hostname: container_manager
    restart: unless-stopped
    command: -H unix:///var/run/docker.sock # Dockerã‚½ã‚±ãƒƒãƒˆã‚’æŒ‡å®š
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Dockerã‚½ã‚±ãƒƒãƒˆã‚’ãƒã‚¦ãƒ³ãƒˆ
      - portainer_data:/data # Portainerã®è¨­å®šãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–

  # --------------------------------------------------------------------------
  #  ğŸ§© ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š (ä¾‹)
  # --------------------------------------------------------------------------
  # GitLab (includeã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹åãŒ 'gitlab' ã®å ´åˆ)
  # gitlab:
  #   networks:
  #     - shared_backend_network
  #   depends_on: # å¿…è¦ã«å¿œã˜ã¦ä¾å­˜é–¢ä¿‚ã‚’è¨­å®š
  #     - postgres_db # ã‚‚ã—GitLabãŒã“ã®DBã‚’ä½¿ã†ãªã‚‰ (é€šå¸¸ã¯GitLabå†…éƒ¨ã«DBã‚’æŒã¤)
  #     - caddy # GitLabãŒCaddyã®å¾Œã«èµ·å‹•ã—ã¦ã»ã—ã„å ´åˆãªã©

  # è‡ªä½œWebã‚¢ãƒ—ãƒª (includeã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹åãŒ 'my_custom_webapp_service' ã®å ´åˆ)
  # my_custom_webapp_service:
  #   networks:
  #     - shared_backend_network
  #   depends_on:
  #     - main_api

# --------------------------------------------------------------------------
#  ğŸ’¾ åå‰ä»˜ããƒœãƒªãƒ¥ãƒ¼ãƒ å®šç¾©
# --------------------------------------------------------------------------
volumes:
  caddy_data:
  caddy_config:
  postgres_db_data:
  pgadmin_data:
  duplicati_config_data:
  duplicati_backups_storage: # TODO: ã“ã‚Œã¯å®Ÿéš›ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆã«å¿œã˜ã¦ãƒ›ã‚¹ãƒˆãƒ‘ã‚¹ãªã©ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨
  db_dumps_staging_area: # pg_dumpã®å‡ºåŠ›å…ˆã§ã‚ã‚Šã€Duplicatiã®å…¥åŠ›å…ƒã¨ãªã‚‹å…±æœ‰ãƒœãƒªãƒ¥ãƒ¼ãƒ 
  portainer_data:

# --------------------------------------------------------------------------
#  ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å®šç¾©
# --------------------------------------------------------------------------
networks:
  frontend_network: # CaddyãŒå¤–éƒ¨ã«å…¬é–‹ã™ã‚‹éš›ã«ä½¿ç”¨
    driver: bridge
    name: ${COMPOSE_PROJECT_NAME}_frontend_net # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å«ã‚€ä¸€æ„ãªåå‰
  shared_backend_network:  # å†…éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é–“ã®é€šä¿¡ç”¨
    driver: bridge
    name: ${COMPOSE_PROJECT_NAME}_backend_net # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å«ã‚€ä¸€æ„ãªåå‰